name: Build & Push Docker Images

on:
  push:
    branches:
      - main
      - dev
    paths:
      - "server/**"
      - "client/**"

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 571600830802

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - name: client
            path: client/apps/web
            ecr: client-web
          - name: auth-service
            path: server/services/auth-service
            ecr: auth-service
          - name: product-service
            path: server/services/product-service
            ecr: product-service

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: Debug Info
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"

      - name: ðŸ” Display Build Context
        run: |
          echo "::group::Build Information"
          echo "ðŸ·ï¸  Service: ${{ matrix.service.name }}"
          echo "ðŸ“ Build Path: ${{ matrix.service.path }}"
          echo "ðŸ“¦ ECR Repository: ${{ matrix.service.ecr }}"
          echo "ðŸŒ¿ Branch: ${GITHUB_REF#refs/heads/}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ðŸ’¬ Commit Message: ${{ github.event.head_commit.message }}"
          echo "ðŸ”— Commit SHA: ${{ github.sha }}"
          echo "::endgroup::"

      - name: ðŸ” Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::571600830802:role/GithubActionsECRRole
          aws-region: ${{ env.AWS_REGION }}

      - name: âœ… Verify AWS Identity
        run: |
          echo "::group::AWS Identity"
          aws sts get-caller-identity
          echo "::endgroup::"

      - name: ðŸ”‘ Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: ðŸ—ï¸  Create ECR Repository if Not Exists
        continue-on-error: true
        run: |
          echo "::group::ECR Repository Check"
          echo "Checking if repository '${{ matrix.service.ecr }}' exists..."

          if aws ecr describe-repositories \
            --repository-names ${{ matrix.service.ecr }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "âœ… Repository already exists"
          else
            echo "ðŸ“¦ Creating repository '${{ matrix.service.ecr }}'..."
            aws ecr create-repository \
              --repository-name ${{ matrix.service.ecr }} \
              --region ${{ env.AWS_REGION }} \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
            echo "âœ… Repository created successfully"
          fi
          echo "::endgroup::"

      - name: ðŸ³ Build & Push Docker Images
        id: docker_build
        run: |
          echo "::group::Docker Build Configuration"

          # Define variables
          ECR_REGISTRY=${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
          IMAGE_NAME=${{ matrix.service.ecr }}
          SHORT_SHA=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

          # Define image tags
          IMAGE_SHA="${ECR_REGISTRY}/${IMAGE_NAME}:${SHORT_SHA}"
          IMAGE_LATEST="${ECR_REGISTRY}/${IMAGE_NAME}:latest"
          IMAGE_DEV="${ECR_REGISTRY}/${IMAGE_NAME}:dev"

          echo "ðŸ“‹ Build Variables:"
          echo "  Registry: ${ECR_REGISTRY}"
          echo "  Image Name: ${IMAGE_NAME}"
          echo "  Short SHA: ${SHORT_SHA}"
          echo "  Build Date: ${BUILD_DATE}"
          echo ""
          echo "ðŸ·ï¸  Image Tags:"
          echo "  SHA Tag: ${IMAGE_SHA}"
          echo "  Latest Tag: ${IMAGE_LATEST}"
          echo "  Dev Tag: ${IMAGE_DEV}"
          echo "::endgroup::"

          # Check if Dockerfile exists
          echo "::group::Pre-build Checks"
          if [ ! -f "${{ matrix.service.path }}/Dockerfile" ]; then
            echo "âŒ ERROR: Dockerfile not found at ${{ matrix.service.path }}/Dockerfile"
            exit 1
          fi
          echo "âœ… Dockerfile found"
          echo "::endgroup::"

          # Build Docker image
          echo "::group::Building Docker Image"
          echo "ðŸ”¨ Building image: ${IMAGE_SHA}"
          docker build \
            --build-arg BUILD_DATE="${BUILD_DATE}" \
            --build-arg VCS_REF="${SHORT_SHA}" \
            --build-arg VERSION="${SHORT_SHA}" \
            -t ${IMAGE_SHA} \
            ${{ matrix.service.path }}

          BUILD_EXIT_CODE=$?
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… Build successful"
          else
            echo "âŒ Build failed with exit code: $BUILD_EXIT_CODE"
            exit $BUILD_EXIT_CODE
          fi
          echo "::endgroup::"

          # Tag images
          echo "::group::Tagging Images"
          echo "ðŸ·ï¸  Tagging image with 'latest' tag..."
          docker tag ${IMAGE_SHA} ${IMAGE_LATEST}
          echo "ðŸ·ï¸  Tagging image with 'dev' tag..."
          docker tag ${IMAGE_SHA} ${IMAGE_DEV}
          echo "âœ… Tagging complete"
          echo "::endgroup::"

          # Display image info
          echo "::group::Image Information"
          docker images | grep ${IMAGE_NAME} || true
          echo "::endgroup::"

          # Push images
          echo "::group::Pushing Images to ECR"
          echo "â¬†ï¸  Pushing SHA tag: ${IMAGE_SHA}"
          docker push ${IMAGE_SHA}
          echo "âœ… SHA tag pushed"

          echo "â¬†ï¸  Pushing latest tag: ${IMAGE_LATEST}"
          docker push ${IMAGE_LATEST}
          echo "âœ… Latest tag pushed"

          echo "â¬†ï¸  Pushing dev tag: ${IMAGE_DEV}"
          docker push ${IMAGE_DEV}
          echo "âœ… Dev tag pushed"
          echo "::endgroup::"

          # Set outputs for summary
          echo "image_sha=${IMAGE_SHA}" >> $GITHUB_OUTPUT
          echo "image_latest=${IMAGE_LATEST}" >> $GITHUB_OUTPUT
          echo "image_dev=${IMAGE_DEV}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Build Summary
        if: always()
        run: |
          echo "### ðŸ³ Docker Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Service | \`${{ matrix.service.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Build Path | \`${{ matrix.service.path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ ECR Repo | \`${{ matrix.service.ecr }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Commit SHA | \`${{ steps.docker_build.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`${GITHUB_REF#refs/heads/}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ·ï¸ Pushed Images:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.docker_build.outputs.image_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.docker_build.outputs.image_latest }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.docker_build.outputs.image_dev }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build completed successfully!**" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "::group::Cleanup"
          echo "ðŸ§¹ Removing local Docker images to free up space..."
          docker rmi ${{ steps.docker_build.outputs.image_sha }} || true
          docker rmi ${{ steps.docker_build.outputs.image_latest }} || true
          docker rmi ${{ steps.docker_build.outputs.image_dev }} || true
          echo "âœ… Cleanup complete"
          echo "::endgroup::"
